<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>sc_sncn_ethercat: module_ethercat/src/eoe.xc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="synapticon.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="synapticon_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">sc_sncn_ethercat
   </div>
   <div id="projectbrief">Implementation of EtherCAT Communication for SOMANET devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('eoe_8xc_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">eoe.xc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="eoe_8xc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="eoe_8h.html">eoe.h</a>&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;print.h&gt;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">struct </span>{</div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a89f234133d3efe315836311cbf21c64b">   43</a></span>&#160;        <span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#a89f234133d3efe315836311cbf21c64b">state</a>;</div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="eoe_8xc.html#ad2aea78054bbdc8fb2b053fdcc4ddd7f">   44</a></span>&#160;        <span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#ad2aea78054bbdc8fb2b053fdcc4ddd7f">rx_buffer</a>;  </div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a43efae89539def5d70a353361726f811">   45</a></span>&#160;        <span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#a43efae89539def5d70a353361726f811">tx_buffer</a>;  </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;} <a class="code" href="eoe_8xc.html#a5ca18b6405abeb009e4469e27da59519">eoe_state</a>;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> sendstate;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> used_rx_buffer;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> used_tx_buffer;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> tx_packet_ready;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> current = 0; <span class="comment">/* FIXME to make use of input buffer rxCurrent and txCurrent should be globals */</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a46556edb8f0106b1ea6d611fce22f2df">   54</a></span>&#160;<span class="preprocessor">#define MAX_ETHERNET_FRAME_BYTES   (MAX_ETHERNET_FRAME+3)</span></div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a14a8fe23640df0074fa75454f3eab115">   55</a></span>&#160;<span class="preprocessor">#define MAX_ETHERNET_FRAME_UINT    (MAX_ETHERNET_FRAME_BYTES/4)</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html">   57</a></span>&#160;<span class="keyword">struct </span><a class="code" href="struct__ethernet__packet.html">_ethernet_packet</a> {</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        <span class="keyword">union </span>{</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">   59</a></span>&#160;                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[<a class="code" href="eoe_8xc.html#a46556edb8f0106b1ea6d611fce22f2df">MAX_ETHERNET_FRAME_BYTES</a>]; </div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html#ab835d22ab0b511fda9e8125eeaeeed70">   60</a></span>&#160;                <span class="keywordtype">unsigned</span> <a class="code" href="struct__ethernet__packet.html#ab835d22ab0b511fda9e8125eeaeeed70">framei</a>[<a class="code" href="eoe_8xc.html#a14a8fe23640df0074fa75454f3eab115">MAX_ETHERNET_FRAME_UINT</a>];      </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        } <a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html#a9aa211cee0faa2e42d3eb11ab33c2dd9">   62</a></span>&#160;        <span class="keywordtype">int</span> <a class="code" href="struct__ethernet__packet.html#a9aa211cee0faa2e42d3eb11ab33c2dd9">ready</a>;                               </div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">   63</a></span>&#160;        <span class="keywordtype">unsigned</span> <a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>;                           </div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">   64</a></span>&#160;        <span class="keywordtype">unsigned</span> <a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a>;                     </div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">   65</a></span>&#160;        <span class="keywordtype">unsigned</span> <a class="code" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">nextFragment</a>;                   </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;};</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">/* FIXME should I really butther the rx/tx ethernet packets??? */</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct__ethernet__packet.html">_ethernet_packet</a> ethernet_packet_rx[<a class="code" href="eoe_8h.html#a3f280404fb85d00f9c066530af3406f9">MAX_ETHERNET_BUFFER</a>];</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="struct__ethernet__packet.html">_ethernet_packet</a> ethernet_packet_tx[<a class="code" href="eoe_8h.html#a3f280404fb85d00f9c066530af3406f9">MAX_ETHERNET_BUFFER</a>];</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> reset_ethernet_packet(<span class="keyword">struct</span> <a class="code" href="struct__ethernet__packet.html">_ethernet_packet</a> &amp;ep)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="eoe_8xc.html#a46556edb8f0106b1ea6d611fce22f2df">MAX_ETHERNET_FRAME_BYTES</a>; i++) {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                ep.<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[i]=0;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        }</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        ep.<a class="code" href="struct__ethernet__packet.html#a9aa211cee0faa2e42d3eb11ab33c2dd9">ready</a>=0;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        ep.<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>=0;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        ep.<a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a>=0;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        ep.<a class="code" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">nextFragment</a>=0;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;}</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> parse_packet(uint16_t msg[], <span class="keywordtype">unsigned</span> <a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>, <span class="keyword">struct</span> <a class="code" href="struct__eoe__packet.html">_eoe_packet</a> &amp;ep)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;{</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="keywordtype">int</span> i=0, k=0;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="keywordtype">unsigned</span> dataLength = 2*(size-2); <span class="comment">/* size is word count, dataLength is byte count, remove the 2 header words */</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#af85f9882d3b5f091b393dbf22e9249f5">type</a> = (char)(msg[0]&amp;0x000f);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#a1167e7a3050f67ff879a6870dbff69e0">eport</a> = (char)((msg[0]&amp;0x00f0)&gt;&gt;4);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">lastFragment</a> = (char)((msg[0]&gt;&gt;8)&amp;0x01);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#ae315b736aa2bb5e6a5fb0ec3a7cc7cb9">timeAppended</a> = (char)((msg[0]&gt;&gt;9)&amp;0x01);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#a4cae8dd80b467ae24d9dc27e17497db7">timeRequest</a> = (char)((msg[0]&gt;&gt;10)&amp;0x01);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a> = (char)(msg[1]&amp;0x2f);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#aefe1a66f265ecb7d51e9e14eaedf2dc6">a</a>.<a class="code" href="struct__eoe__packet.html#a231f5c35f182cb79690feed48d643f34">offset</a> = (char)((msg[1]&gt;&gt;6)&amp;0x2f);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#af217cc8e4fd28e3998ee86d498b2d307">frameNumber</a> = (char)((msg[1]&gt;&gt;12)&amp;0x0f);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="keywordflow">if</span> (ep.<a class="code" href="struct__eoe__packet.html#ae315b736aa2bb5e6a5fb0ec3a7cc7cb9">timeAppended</a> == 1) {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                dataLength -= 4;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <span class="keywordflow">for</span> (i=2, k=0; k&lt;dataLength &amp;&amp; i&lt;<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>; i++, k+=2) {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                ep.<a class="code" href="struct__eoe__packet.html#a6977277f26c38a0ab09fad4f80dd07cc">b</a>.<a class="code" href="struct__eoe__packet.html#af4f3899908ab52ffdcf9c610aca167fb">data</a>[k] = (char)msg[i]&amp;0xff;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                ep.<a class="code" href="struct__eoe__packet.html#a6977277f26c38a0ab09fad4f80dd07cc">b</a>.<a class="code" href="struct__eoe__packet.html#af4f3899908ab52ffdcf9c610aca167fb">data</a>[k+1] = (char)((msg[i]&gt;&gt;8)&amp;0xff);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">if</span> (ep.<a class="code" href="struct__eoe__packet.html#ae315b736aa2bb5e6a5fb0ec3a7cc7cb9">timeAppended</a> == 1) {</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                ep.<a class="code" href="struct__eoe__packet.html#a67850d0fd3b7bc78e1ccdc4c89699a78">timestamp</a> = ((uint32_t)msg[i+3]&lt;&lt;24) &amp;&amp; ((uint32_t)msg[i+2]&lt;&lt;16) &amp;&amp; ((uint32_t)msg[i+1]&lt;&lt;8) &amp;&amp; (uint32_t)msg[i]; <span class="comment">/* FIXME check for quirks */</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        }</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="keywordflow">return</span> k;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;}</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a75a07dc1df5e3db444d84991a3bd908d">  118</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="eoe_8xc.html#a75a07dc1df5e3db444d84991a3bd908d">eoe_init</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;{</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        sendstate = <a class="code" href="eoe_8h.html#a17bda54b7051f74ebfb007be872a6fe1">EOE_STATE_IDLE</a>;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        tx_packet_ready = 0;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        used_rx_buffer = 0;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        used_tx_buffer = 0;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <a class="code" href="eoe_8xc.html#a5ca18b6405abeb009e4469e27da59519">eoe_state</a>.state = <a class="code" href="eoe_8h.html#a17bda54b7051f74ebfb007be872a6fe1">EOE_STATE_IDLE</a>;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="eoe_8h.html#a3f280404fb85d00f9c066530af3406f9">MAX_ETHERNET_BUFFER</a>; i++) {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                reset_ethernet_packet(ethernet_packet_rx[i]);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                reset_ethernet_packet(ethernet_packet_tx[i]);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        }</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;}</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">/* FIXME at least for transmission, build a 3 stage buffer (size: 3*1518 + overhead) */</span></div>
<div class="line"><a name="l00136"></a><span class="lineno"><a class="line" href="eoe_8xc.html#ac89dd7f6244272d631682706f9c3c4d3">  136</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#ac89dd7f6244272d631682706f9c3c4d3">eoe_tx_handler</a>(chanend eoe, <span class="keywordtype">unsigned</span> size)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;{</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="comment">/* read eoe channel</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">         * until complete package is finished</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">         * if no RX is in progress split package and successivly send the chunks</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">         *</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">         * size is given as number of 32-bit words</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <span class="keywordtype">unsigned</span> otmp;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordtype">unsigned</span> pos = 0;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="comment">//printstr(&quot;[DEBUG EOE TX] working eoe_tx_handler() rec. size: &quot;); printintln(size);</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">while</span> (pos&lt;((<a class="code" href="eoe_8h.html#a03c1f781ac52d5c4f4659d7dee3129ef">MAX_ETHERNET_FRAME</a>+3)/4) &amp;&amp; pos&lt;size) {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                select  {</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                <span class="keywordflow">case</span> eoe :&gt; otmp :</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                        eoe :&gt; otmp;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                        ethernet_packet_tx[current].<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#ab835d22ab0b511fda9e8125eeaeeed70">framei</a>[pos++] = otmp;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">                        ethernet_packet_tx[current].f.frameb[pos++] = otmp&amp;0xff;</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">                        ethernet_packet_tx[current].f.frameb[pos++] = (otmp&gt;&gt;8)&amp;0xff;</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">                         */</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                        <span class="comment">/* no packet waiting in transfere channel */</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                }</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        }</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="comment">/* construct ethercat packet */</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        ethernet_packet_tx[current].<a class="code" href="struct__ethernet__packet.html#a9aa211cee0faa2e42d3eb11ab33c2dd9">ready</a> = 1;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        ethernet_packet_tx[current].<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a> = size*4; <span class="comment">/* set size as number of octets */</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        ethernet_packet_tx[current].<a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a> = 0;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        ethernet_packet_tx[current].<a class="code" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">nextFragment</a> = 0; <span class="comment">/* FIXME */</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;}</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">/* FIXME refactor to push packet segments directly to mii */</span></div>
<div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a220dd05187dd250be9dfb4e5f2c19354">  180</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#a220dd05187dd250be9dfb4e5f2c19354">eoe_rx_handler</a>(chanend eoe, chanend sig, uint16_t msg[], <span class="keywordtype">unsigned</span> size)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;{</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="keywordtype">int</span> ret = 0;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        <span class="keywordtype">int</span> type;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="keywordtype">int</span> eport;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordtype">unsigned</span> i, k;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keywordtype">unsigned</span> rxoffset;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordtype">unsigned</span> packetSize;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keywordtype">unsigned</span> tmp;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">int</span> lastRecFragment = -1; <span class="comment">/* last received fragment number - resets to 0 if new ethernet frame starts */</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">int</span> currentFrameNumber = -1; <span class="comment">/* current number of the ethernet frame. */</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        <span class="comment">/* static char receiveFrame = 0; / * we receive frame */</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="keyword">struct </span><a class="code" href="struct__eoe__packet.html">_eoe_packet</a> inpacket;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        packetSize = parse_packet(msg, size, inpacket);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="comment">/* FIXME when is a duplicate fragment send??? This is not necessary a</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">         * error, it could result in a not acknoledged packet, but there is no</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">         * such ack I could use! */</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="comment">/* ignore duplicate packets - no error, just wait for the next valid packet */</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="keywordflow">if</span> (inpacket.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a> == lastRecFragment) {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                printstr(<span class="stringliteral">&quot;[DEBUG ERR eoe.xc] Received duplicate Fragment\n&quot;</span>);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="comment">/* a out of order fragment is received, something went wrong during transmission */</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="keywordflow">if</span> (inpacket.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a> &lt; lastRecFragment) {</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                printstr(<span class="stringliteral">&quot;[DEBUG ERR eoe.xc] Malicious Fragment (fragmentNr/ lasRecFragment) &quot;</span>);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                printint(inpacket.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a>); printstr(<span class="stringliteral">&quot; &quot;</span>); printintln(lastRecFragment);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;                lastRecFragment = -1;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                currentFrameNumber = -1;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                reset_ethernet_packet(ethernet_packet_rx[0]); <span class="comment">/* FIXME make a reset function */</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        lastRecFragment = inpacket.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a>;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keywordflow">if</span> (currentFrameNumber == -1) { <span class="comment">/* a new ethernet frame has started */</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                currentFrameNumber = inpacket.<a class="code" href="struct__eoe__packet.html#af217cc8e4fd28e3998ee86d498b2d307">frameNumber</a>;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="comment">/* check if ethernet frames are in order */</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">if</span> (inpacket.<a class="code" href="struct__eoe__packet.html#af217cc8e4fd28e3998ee86d498b2d307">frameNumber</a> != currentFrameNumber) {</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                <span class="comment">//printstr(&quot;[DEBUG ERR eoe.xc] Errornous packet received\n&quot;);</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                lastRecFragment = -1;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                currentFrameNumber = -1;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                reset_ethernet_packet(ethernet_packet_rx[0]); <span class="comment">/* FIXME make a reset function */</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        }</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="comment">/* FIXME check packet time, if too large abort transmission? * /</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">        if (inpacket.timeAppended == 1) {</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">        // */</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="comment">/* FIXME handle optional SET_IP_PARAMETER (0x02) and SET_ADDRESS_FILTER (0x04) ??? */</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="keywordflow">switch</span> (inpacket.<a class="code" href="struct__eoe__packet.html#af85f9882d3b5f091b393dbf22e9249f5">type</a>) {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="comment">/*case EOE_INIT_REQ: / * remove this, because this is not handled correctly -&gt; EOE_IP_PARAM_REQ is equal */</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="eoe_8h.html#a63abe88134268d5e9512aee8e53e9582">EOE_FRAGMENT_REQ</a>:</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                rxoffset = ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a>;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                <span class="keywordflow">if</span> (rxoffset+packetSize &gt;= <a class="code" href="eoe_8h.html#a03c1f781ac52d5c4f4659d7dee3129ef">MAX_ETHERNET_FRAME</a>) {</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                        printstr(<span class="stringliteral">&quot;[DEBUG EOE_XC] Error, ethernet frame too big.\nThe first 10 bytes: &quot;</span>);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                        <span class="keywordflow">for</span> (i=0; i&lt;10; i++) {</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                                printhex(ethernet_packet_rx[0].f.<a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[i]);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                                printstr(<span class="stringliteral">&quot; &quot;</span>);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                        }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                        printstr(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                        lastRecFragment = -1;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                        currentFrameNumber = -1;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                        reset_ethernet_packet(ethernet_packet_rx[0]);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                <span class="keywordflow">for</span> (i=0; i&lt;packetSize &amp;&amp; i&lt;<a class="code" href="eoe_8h.html#a5f46dd1208aa32dfb3731c079a29060d">MAX_EOE_DATA</a>; i++) {</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                        ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[rxoffset+i] = inpacket.<a class="code" href="struct__eoe__packet.html#a6977277f26c38a0ab09fad4f80dd07cc">b</a>.<a class="code" href="struct__eoe__packet.html#af4f3899908ab52ffdcf9c610aca167fb">data</a>[i];</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                }</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a> = rxoffset+packetSize;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a> += packetSize;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                <span class="keywordflow">if</span> (inpacket.<a class="code" href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">lastFragment</a> == 1) {</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                        <span class="keywordtype">unsigned</span> datalen = ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                        <span class="keywordflow">if</span> (datalen&lt;64) <span class="comment">/* FIXME should be 60, but then 4 bytes are missing - guess: it&#39;s the missing FCS */</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                                datalen=64;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                        <span class="comment">//for (i=0; i&lt;(ethernet_packet_rx[0].size+3)/4; i++) {</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                        <span class="keywordflow">for</span> (i=0; i&lt;(datalen+3)/4; i++) {</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                                eoe &lt;: ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#ab835d22ab0b511fda9e8125eeaeeed70">framei</a>[i];</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                        }</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                        <span class="comment">/* Extended debug * /</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">                        printstr(&quot;DEBUG Packet received: &quot;);</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">                        for (i=0; i&lt;ethernet_packet_rx[0].size; i++) {</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">                                printhex(ethernet_packet_rx[0].f.frameb[i]);</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">                                printstr(&quot; &quot;);</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">                        }</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">                        printstr(&quot;\n&quot;);</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">                        / * end debug */</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                        <span class="keywordflow">for</span> (i=0; i&lt;ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>; i++) {</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                                tmp = ethernet_packet_rx[0].<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[i];</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                                i++;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                                tmp |= ((unsigned)ethernet_packet_rx[0].frame[i]&lt;&lt;8)&amp;0xff00;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                                eoe &lt;: tmp;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                                <span class="comment">//eoe &lt;: (int)ethernet_packet_rx[0].frame[i];</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                        }</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                        sig &lt;: 1;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                        <a class="code" href="eoe_8xc.html#a5ca18b6405abeb009e4469e27da59519">eoe_state</a>.state = <a class="code" href="eoe_8h.html#a17bda54b7051f74ebfb007be872a6fe1">EOE_STATE_IDLE</a><span class="comment">/*RX_LAST_FRAGMENT*/</span>;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                        reset_ethernet_packet(ethernet_packet_rx[0]);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                        currentFrameNumber = -1;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                        lastRecFragment = -1;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                }</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="eoe_8h.html#a0979ed5887876805393ae525fd85153b">EOE_IP_PARAM_REQ</a>:</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                printstr(<span class="stringliteral">&quot;[DEBUG ERROR] Packet of type 0x&quot;</span>);</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                printhex(inpacket.<a class="code" href="struct__eoe__packet.html#af85f9882d3b5f091b393dbf22e9249f5">type</a>);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                printstr(<span class="stringliteral">&quot; not supported\n&quot;</span>);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        }</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;}</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno"><a class="line" href="eoe_8xc.html#acbe341b5808c62a800c54b19e370e453">  310</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#acbe341b5808c62a800c54b19e370e453">eoe_tx_ready</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;{</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="keywordflow">return</span> ethernet_packet_tx[current].<a class="code" href="struct__ethernet__packet.html#a9aa211cee0faa2e42d3eb11ab33c2dd9">ready</a>;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;}</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">/* FIXME rename eoe_get_reply() -&gt; eoe_get_tx_packet() */</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">/* FIXME add last segment check and clear buffer after last segment */</span></div>
<div class="line"><a name="l00323"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a84d87f7e9da0e554b9d6b7ae6fef802a">  323</a></span>&#160;<span class="keywordtype">unsigned</span> <a class="code" href="eoe_8xc.html#a84d87f7e9da0e554b9d6b7ae6fef802a">eoe_get_reply</a>(uint16_t msg[])</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;{</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordtype">int</span> k=0;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="keywordtype">unsigned</span> tmpl, tmph;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="keywordtype">unsigned</span> length=0;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="keyword">struct </span><a class="code" href="struct__eoe__packet.html">_eoe_packet</a> ep;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keyword">static</span> <span class="keywordtype">unsigned</span> ethCurrentFrame = 0;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="comment">//printstr(&quot;[DEBUG eoe_get_reply()] Building EoE reply\n&quot;);</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <span class="keywordflow">if</span> (ethernet_packet_tx[0].ready == 0) {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        }</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="comment">/* construct header */</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#af85f9882d3b5f091b393dbf22e9249f5">type</a> = <a class="code" href="eoe_8h.html#a63abe88134268d5e9512aee8e53e9582">EOE_FRAGMENT_REQ</a>;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#a1167e7a3050f67ff879a6870dbff69e0">eport</a> = 0; <span class="comment">/* FIXME check port usage */</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#ae315b736aa2bb5e6a5fb0ec3a7cc7cb9">timeAppended</a> = 0; <span class="comment">/* depends on mii TX_TIMESTAMP_END_OF_PACKET */</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#a4cae8dd80b467ae24d9dc27e17497db7">timeRequest</a> = 0;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#a35f984785b7723c9c8b2486d496b9b2a">reserved</a> = 0x00;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#aefe1a66f265ecb7d51e9e14eaedf2dc6">a</a>.<a class="code" href="struct__eoe__packet.html#a231f5c35f182cb79690feed48d643f34">offset</a> = 0; <span class="comment">/* is set below if current size is known! */</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="comment">//ep.fragmentNumber = 0;</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a> = ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">nextFragment</a> &amp; 0x2f;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">nextFragment</a> += 1; <span class="comment">/* FIXME if last fragment the nextFragment field should be 0 and ethernet_packet_tx should be cleared */</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#af217cc8e4fd28e3998ee86d498b2d307">frameNumber</a> = ethCurrentFrame;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        ethCurrentFrame = (ethCurrentFrame&lt;0xf) ? ethCurrentFrame+1 : 0; <span class="comment">/* CurrentFrame is a 4 bit sequence counter */</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <span class="keywordflow">if</span> (((ethernet_packet_tx[0].currentpos + <a class="code" href="eoe_8h.html#a5a0c44107cd80ae90486c68cef94183c">EOE_MAX_DATA_SIZE</a>) &gt;= ethernet_packet_tx[0].size) ||</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                (ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a> &lt; <a class="code" href="eoe_8h.html#a5a0c44107cd80ae90486c68cef94183c">EOE_MAX_DATA_SIZE</a>)) {</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <span class="comment">//printstr(&quot;[DEBUG eoe.xc] +++ set last fragment\n&quot;);</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                ep.<a class="code" href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">lastFragment</a> = 1;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                ep.<a class="code" href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">lastFragment</a> = 0;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">nextFragment</a>++;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        }</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <span class="comment">//unsigned startidx = ethernet_packet_tx[0].currentpos;</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="comment">/* build send packet */</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        <span class="comment">/* FIXME fix header construction */</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        <span class="comment">//msg[k] = (ep.type &amp; (ep.eport&lt;&lt;4)) &amp; (ep.lastFragment &amp; (ep.timeAppended&lt;&lt;1) &amp; (ep.timeRequest&lt;&lt;2))&lt;&lt;8;</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        msg[0] = (ep.<a class="code" href="struct__eoe__packet.html#af85f9882d3b5f091b393dbf22e9249f5">type</a>&amp;0x0f);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        msg[0] |= (ep.<a class="code" href="struct__eoe__packet.html#a1167e7a3050f67ff879a6870dbff69e0">eport</a>&lt;&lt;4)&amp;0xf0;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        msg[0] |= (ep.<a class="code" href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">lastFragment</a>&lt;&lt;8)&amp;0x100;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        msg[0] |= (ep.<a class="code" href="struct__eoe__packet.html#ae315b736aa2bb5e6a5fb0ec3a7cc7cb9">timeAppended</a>&lt;&lt;9)&amp;0x200;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        msg[0] |= (ep.<a class="code" href="struct__eoe__packet.html#a4cae8dd80b467ae24d9dc27e17497db7">timeRequest</a>&lt;&lt;10)&amp;0x400;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="comment">/* remaining 5 bit are reserved so 0, no need to set explicitly */</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="comment">//printstr(&quot;DEBUG first header word: &quot;); printhexln(msg[0]);</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        msg[1] = ep.<a class="code" href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">fragmentNumber</a>&amp;0x3f;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        msg[1] |= (ep.<a class="code" href="struct__eoe__packet.html#aefe1a66f265ecb7d51e9e14eaedf2dc6">a</a>.<a class="code" href="struct__eoe__packet.html#a231f5c35f182cb79690feed48d643f34">offset</a>&lt;&lt;6)&amp;0xfc0;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        msg[1] |= (ep.<a class="code" href="struct__eoe__packet.html#af217cc8e4fd28e3998ee86d498b2d307">frameNumber</a>&lt;&lt;12)&amp;0xf000;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        k=2;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">for</span> (i=ethernet_packet_tx[0].currentpos; i&lt;<a class="code" href="eoe_8h.html#a5a0c44107cd80ae90486c68cef94183c">EOE_MAX_DATA_SIZE</a> &amp;&amp; i&lt;(ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">size</a>-ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a>); i+=2, k++) {</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                tmpl = ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[i];</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                tmph = ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">f</a>.<a class="code" href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">frameb</a>[i+1];</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                msg[k] = ((tmph&lt;&lt;8)&amp;0xff00) | (tmpl&amp;0xff);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        }</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        length += k; <span class="comment">/* number of 16-bit words */</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        ethernet_packet_tx[0].<a class="code" href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">currentpos</a> += i;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        <span class="comment">/* fix offset field for real value */</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        ep.<a class="code" href="struct__eoe__packet.html#aefe1a66f265ecb7d51e9e14eaedf2dc6">a</a>.<a class="code" href="struct__eoe__packet.html#a231f5c35f182cb79690feed48d643f34">offset</a> = (i+31)/32; <span class="comment">/* number of bytes is used here */</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        msg[1] |= (ep.<a class="code" href="struct__eoe__packet.html#aefe1a66f265ecb7d51e9e14eaedf2dc6">a</a>.<a class="code" href="struct__eoe__packet.html#a231f5c35f182cb79690feed48d643f34">offset</a>&lt;&lt;6)&amp;0xfc0;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        <span class="keywordflow">if</span> (ep.<a class="code" href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">lastFragment</a>)</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                reset_ethernet_packet(ethernet_packet_tx[0]);</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        <span class="keywordflow">return</span> length;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;}</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno"><a class="line" href="eoe_8xc.html#a0d6d01ce3a6fbb1d6548b9e34b8b7bb1">  397</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="eoe_8xc.html#a0d6d01ce3a6fbb1d6548b9e34b8b7bb1">eoe_check_chunks</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;{</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="keywordflow">if</span> (ethernet_packet_tx[0].currentpos &lt; ethernet_packet_tx[0].size) {</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        }</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;}</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="ttc" id="eoe_8h_html_a63abe88134268d5e9512aee8e53e9582"><div class="ttname"><a href="eoe_8h.html#a63abe88134268d5e9512aee8e53e9582">EOE_FRAGMENT_REQ</a></div><div class="ttdeci">#define EOE_FRAGMENT_REQ</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00058">eoe.h:58</a></div></div>
<div class="ttc" id="eoe_8xc_html_a5ca18b6405abeb009e4469e27da59519"><div class="ttname"><a href="eoe_8xc.html#a5ca18b6405abeb009e4469e27da59519">eoe_state</a></div><div class="ttdeci">struct @2 eoe_state</div></div>
<div class="ttc" id="struct__ethernet__packet_html_a3d8ab58eba25993d2d5e551c975e1167"><div class="ttname"><a href="struct__ethernet__packet.html#a3d8ab58eba25993d2d5e551c975e1167">_ethernet_packet::nextFragment</a></div><div class="ttdeci">unsigned nextFragment</div><div class="ttdoc">fragment counter (starts with 0) </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00065">eoe.xc:65</a></div></div>
<div class="ttc" id="eoe_8xc_html_a14a8fe23640df0074fa75454f3eab115"><div class="ttname"><a href="eoe_8xc.html#a14a8fe23640df0074fa75454f3eab115">MAX_ETHERNET_FRAME_UINT</a></div><div class="ttdeci">#define MAX_ETHERNET_FRAME_UINT</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00055">eoe.xc:55</a></div></div>
<div class="ttc" id="eoe_8xc_html_a84d87f7e9da0e554b9d6b7ae6fef802a"><div class="ttname"><a href="eoe_8xc.html#a84d87f7e9da0e554b9d6b7ae6fef802a">eoe_get_reply</a></div><div class="ttdeci">unsigned eoe_get_reply(uint16_t msg[])</div><div class="ttdoc">Get eoe reply. </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00323">eoe.xc:323</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_a67850d0fd3b7bc78e1ccdc4c89699a78"><div class="ttname"><a href="struct__eoe__packet.html#a67850d0fd3b7bc78e1ccdc4c89699a78">_eoe_packet::timestamp</a></div><div class="ttdeci">uint32_t timestamp</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00144">eoe.h:144</a></div></div>
<div class="ttc" id="eoe_8h_html"><div class="ttname"><a href="eoe_8h.html">eoe.h</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_a231f5c35f182cb79690feed48d643f34"><div class="ttname"><a href="struct__eoe__packet.html#a231f5c35f182cb79690feed48d643f34">_eoe_packet::offset</a></div><div class="ttdeci">char offset</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00134">eoe.h:134</a></div></div>
<div class="ttc" id="eoe_8xc_html_a0d6d01ce3a6fbb1d6548b9e34b8b7bb1"><div class="ttname"><a href="eoe_8xc.html#a0d6d01ce3a6fbb1d6548b9e34b8b7bb1">eoe_check_chunks</a></div><div class="ttdeci">int eoe_check_chunks(void)</div><div class="ttdoc">Check if more chunks are present for transfere. </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00397">eoe.xc:397</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_af217cc8e4fd28e3998ee86d498b2d307"><div class="ttname"><a href="struct__eoe__packet.html#af217cc8e4fd28e3998ee86d498b2d307">_eoe_packet::frameNumber</a></div><div class="ttdeci">char frameNumber</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00136">eoe.h:136</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_af4f3899908ab52ffdcf9c610aca167fb"><div class="ttname"><a href="struct__eoe__packet.html#af4f3899908ab52ffdcf9c610aca167fb">_eoe_packet::data</a></div><div class="ttdeci">unsigned char data[MAX_EOE_DATA]</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00139">eoe.h:139</a></div></div>
<div class="ttc" id="eoe_8xc_html_a46556edb8f0106b1ea6d611fce22f2df"><div class="ttname"><a href="eoe_8xc.html#a46556edb8f0106b1ea6d611fce22f2df">MAX_ETHERNET_FRAME_BYTES</a></div><div class="ttdeci">#define MAX_ETHERNET_FRAME_BYTES</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00054">eoe.xc:54</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_a1167e7a3050f67ff879a6870dbff69e0"><div class="ttname"><a href="struct__eoe__packet.html#a1167e7a3050f67ff879a6870dbff69e0">_eoe_packet::eport</a></div><div class="ttdeci">char eport</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00126">eoe.h:126</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html_a04390bc48c65f87097a13adc634f324e"><div class="ttname"><a href="struct__ethernet__packet.html#a04390bc48c65f87097a13adc634f324e">_ethernet_packet::f</a></div><div class="ttdeci">union _ethernet_packet::@3 f</div></div>
<div class="ttc" id="eoe_8xc_html_a75a07dc1df5e3db444d84991a3bd908d"><div class="ttname"><a href="eoe_8xc.html#a75a07dc1df5e3db444d84991a3bd908d">eoe_init</a></div><div class="ttdeci">void eoe_init(void)</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00118">eoe.xc:118</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html_ab835d22ab0b511fda9e8125eeaeeed70"><div class="ttname"><a href="struct__ethernet__packet.html#ab835d22ab0b511fda9e8125eeaeeed70">_ethernet_packet::framei</a></div><div class="ttdeci">unsigned framei[MAX_ETHERNET_FRAME_UINT]</div><div class="ttdoc">package payload int32 representation </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00060">eoe.xc:60</a></div></div>
<div class="ttc" id="eoe_8xc_html_a89f234133d3efe315836311cbf21c64b"><div class="ttname"><a href="eoe_8xc.html#a89f234133d3efe315836311cbf21c64b">state</a></div><div class="ttdeci">int state</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00043">eoe.xc:43</a></div></div>
<div class="ttc" id="eoe_8h_html_a03c1f781ac52d5c4f4659d7dee3129ef"><div class="ttname"><a href="eoe_8h.html#a03c1f781ac52d5c4f4659d7dee3129ef">MAX_ETHERNET_FRAME</a></div><div class="ttdeci">#define MAX_ETHERNET_FRAME</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00072">eoe.h:72</a></div></div>
<div class="ttc" id="eoe_8h_html_a0979ed5887876805393ae525fd85153b"><div class="ttname"><a href="eoe_8h.html#a0979ed5887876805393ae525fd85153b">EOE_IP_PARAM_REQ</a></div><div class="ttdeci">#define EOE_IP_PARAM_REQ</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00060">eoe.h:60</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html"><div class="ttname"><a href="struct__ethernet__packet.html">_ethernet_packet</a></div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00057">eoe.xc:57</a></div></div>
<div class="ttc" id="struct__eoe__packet_html"><div class="ttname"><a href="struct__eoe__packet.html">_eoe_packet</a></div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00123">eoe.h:123</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html_ae4fbe1400946860a724f7b127812deae"><div class="ttname"><a href="struct__ethernet__packet.html#ae4fbe1400946860a724f7b127812deae">_ethernet_packet::currentpos</a></div><div class="ttdeci">unsigned currentpos</div><div class="ttdoc">current position of read </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00064">eoe.xc:64</a></div></div>
<div class="ttc" id="eoe_8xc_html_acbe341b5808c62a800c54b19e370e453"><div class="ttname"><a href="eoe_8xc.html#acbe341b5808c62a800c54b19e370e453">eoe_tx_ready</a></div><div class="ttdeci">int eoe_tx_ready(void)</div><div class="ttdoc">check if a tx packet is ready for transmission. </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00310">eoe.xc:310</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_a4cae8dd80b467ae24d9dc27e17497db7"><div class="ttname"><a href="struct__eoe__packet.html#a4cae8dd80b467ae24d9dc27e17497db7">_eoe_packet::timeRequest</a></div><div class="ttdeci">char timeRequest</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00129">eoe.h:129</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_a6977277f26c38a0ab09fad4f80dd07cc"><div class="ttname"><a href="struct__eoe__packet.html#a6977277f26c38a0ab09fad4f80dd07cc">_eoe_packet::b</a></div><div class="ttdeci">union _eoe_packet::@1 b</div></div>
<div class="ttc" id="struct__eoe__packet_html_ae315b736aa2bb5e6a5fb0ec3a7cc7cb9"><div class="ttname"><a href="struct__eoe__packet.html#ae315b736aa2bb5e6a5fb0ec3a7cc7cb9">_eoe_packet::timeAppended</a></div><div class="ttdeci">char timeAppended</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00128">eoe.h:128</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_aefe1a66f265ecb7d51e9e14eaedf2dc6"><div class="ttname"><a href="struct__eoe__packet.html#aefe1a66f265ecb7d51e9e14eaedf2dc6">_eoe_packet::a</a></div><div class="ttdeci">union _eoe_packet::@0 a</div></div>
<div class="ttc" id="eoe_8xc_html_a220dd05187dd250be9dfb4e5f2c19354"><div class="ttname"><a href="eoe_8xc.html#a220dd05187dd250be9dfb4e5f2c19354">eoe_rx_handler</a></div><div class="ttdeci">int eoe_rx_handler(chanend eoe, chanend sig, uint16_t msg[], unsigned size)</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00180">eoe.xc:180</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_af85f9882d3b5f091b393dbf22e9249f5"><div class="ttname"><a href="struct__eoe__packet.html#af85f9882d3b5f091b393dbf22e9249f5">_eoe_packet::type</a></div><div class="ttdeci">char type</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00125">eoe.h:125</a></div></div>
<div class="ttc" id="eoe_8h_html_a3f280404fb85d00f9c066530af3406f9"><div class="ttname"><a href="eoe_8h.html#a3f280404fb85d00f9c066530af3406f9">MAX_ETHERNET_BUFFER</a></div><div class="ttdeci">#define MAX_ETHERNET_BUFFER</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00073">eoe.h:73</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html_adc22d17c88b425d764c4ea59bfe978de"><div class="ttname"><a href="struct__ethernet__packet.html#adc22d17c88b425d764c4ea59bfe978de">_ethernet_packet::frameb</a></div><div class="ttdeci">unsigned char frameb[MAX_ETHERNET_FRAME_BYTES]</div><div class="ttdoc">package payload byte representation </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00059">eoe.xc:59</a></div></div>
<div class="ttc" id="eoe_8xc_html_a43efae89539def5d70a353361726f811"><div class="ttname"><a href="eoe_8xc.html#a43efae89539def5d70a353361726f811">tx_buffer</a></div><div class="ttdeci">int tx_buffer</div><div class="ttdoc">index of used tx buffer </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00045">eoe.xc:45</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_aa0688ef76abbcaeddf1358310d069557"><div class="ttname"><a href="struct__eoe__packet.html#aa0688ef76abbcaeddf1358310d069557">_eoe_packet::fragmentNumber</a></div><div class="ttdeci">char fragmentNumber</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00131">eoe.h:131</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_ac92de06fa8d58a8b1dc6ac48dbb46c51"><div class="ttname"><a href="struct__eoe__packet.html#ac92de06fa8d58a8b1dc6ac48dbb46c51">_eoe_packet::lastFragment</a></div><div class="ttdeci">char lastFragment</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00127">eoe.h:127</a></div></div>
<div class="ttc" id="eoe_8h_html_a5f46dd1208aa32dfb3731c079a29060d"><div class="ttname"><a href="eoe_8h.html#a5f46dd1208aa32dfb3731c079a29060d">MAX_EOE_DATA</a></div><div class="ttdeci">#define MAX_EOE_DATA</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00079">eoe.h:79</a></div></div>
<div class="ttc" id="eoe_8xc_html_ad2aea78054bbdc8fb2b053fdcc4ddd7f"><div class="ttname"><a href="eoe_8xc.html#ad2aea78054bbdc8fb2b053fdcc4ddd7f">rx_buffer</a></div><div class="ttdeci">int rx_buffer</div><div class="ttdoc">index of used rx buffer </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00044">eoe.xc:44</a></div></div>
<div class="ttc" id="eoe_8xc_html_ac89dd7f6244272d631682706f9c3c4d3"><div class="ttname"><a href="eoe_8xc.html#ac89dd7f6244272d631682706f9c3c4d3">eoe_tx_handler</a></div><div class="ttdeci">int eoe_tx_handler(chanend eoe, unsigned size)</div><div class="ttdoc">Get tx packet from mii handler. </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00136">eoe.xc:136</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html_a9aa211cee0faa2e42d3eb11ab33c2dd9"><div class="ttname"><a href="struct__ethernet__packet.html#a9aa211cee0faa2e42d3eb11ab33c2dd9">_ethernet_packet::ready</a></div><div class="ttdeci">int ready</div><div class="ttdoc">this packet is ready for transmission </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00062">eoe.xc:62</a></div></div>
<div class="ttc" id="eoe_8h_html_a17bda54b7051f74ebfb007be872a6fe1"><div class="ttname"><a href="eoe_8h.html#a17bda54b7051f74ebfb007be872a6fe1">EOE_STATE_IDLE</a></div><div class="ttdeci">#define EOE_STATE_IDLE</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00081">eoe.h:81</a></div></div>
<div class="ttc" id="eoe_8h_html_a5a0c44107cd80ae90486c68cef94183c"><div class="ttname"><a href="eoe_8h.html#a5a0c44107cd80ae90486c68cef94183c">EOE_MAX_DATA_SIZE</a></div><div class="ttdeci">#define EOE_MAX_DATA_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00077">eoe.h:77</a></div></div>
<div class="ttc" id="struct__ethernet__packet_html_ac2c6a2cc4f4c1d76a3b135714a3f238a"><div class="ttname"><a href="struct__ethernet__packet.html#ac2c6a2cc4f4c1d76a3b135714a3f238a">_ethernet_packet::size</a></div><div class="ttdeci">unsigned size</div><div class="ttdoc">payload size of this package </div><div class="ttdef"><b>Definition:</b> <a href="eoe_8xc_source.html#l00063">eoe.xc:63</a></div></div>
<div class="ttc" id="struct__eoe__packet_html_a35f984785b7723c9c8b2486d496b9b2a"><div class="ttname"><a href="struct__eoe__packet.html#a35f984785b7723c9c8b2486d496b9b2a">_eoe_packet::reserved</a></div><div class="ttdeci">char reserved</div><div class="ttdef"><b>Definition:</b> <a href="eoe_8h_source.html#l00130">eoe.h:130</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_07bd8aa21d7b6d2c17c75cf15b658a12.html">module_ethercat</a></li><li class="navelem"><a class="el" href="dir_a2fe551c5c0583e07c257de604a7b33f.html">src</a></li><li class="navelem"><a class="el" href="eoe_8xc.html">eoe.xc</a></li>
    <li class="footer">Developed at
    <a href="http://www.synapticon.com">
    <img class="footer" style="width: 30%" src="synapticon-logo-scaled.png" alt="Synapticon"/></a>&nbsp;(Documentation generated on Wed Mar 5 2014)</li>
  </ul>
</div>
</body>
</html>